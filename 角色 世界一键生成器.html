<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>📚 SillyTavern 世界书 & 角色卡生成器</title>
<style>
:root {
  --primary: #6c63ff;
  --primary-dark: #574fd6;
  --secondary: #ff6f61;
  --secondary-dark: #e85a50;
  --light: #f8f9fa;
  --dark: #333;
  --success: #28a745;
  --warning: #ffc107;
  --danger: #dc3545;
  --gray: #6c757d;
  --light-gray: #e9ecef;
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  line-height: 1.6;
  color: var(--dark);
  background: linear-gradient(135deg, #f0f2f5, #e4e7eb);
  padding: 20px;
  min-height: 100vh;
}

.container {
  max-width: 1200px;
  margin: 0 auto;
}

header {
  text-align: center;
  margin-bottom: 30px;
  padding: 25px;
  background: rgba(255, 255, 255, 0.9);
  border-radius: 20px;
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
  position: relative;
  overflow: hidden;
}

header::before {
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 5px;
  background: linear-gradient(90deg, var(--primary), var(--secondary));
}

h1 {
  color: var(--primary);
  font-size: 2.8rem;
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 15px;
  text-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.tabs {
  display: flex;
  justify-content: center;
  margin-bottom: 30px;
  gap: 15px;
  flex-wrap: wrap;
}

.tabs button {
  background: var(--primary);
  color: white;
  border: none;
  padding: 15px 30px;
  border-radius: 50px;
  cursor: pointer;
  transition: all 0.3s ease;
  font-size: 1.2rem;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 10px;
  box-shadow: 0 4px 12px rgba(108, 99, 255, 0.3);
  position: relative;
  overflow: hidden;
  z-index: 1;
}

.tabs button:hover {
  background: var(--primary-dark);
  transform: translateY(-5px);
  box-shadow: 0 6px 15px rgba(108, 99, 255, 0.4);
}

.tab {
  display: none;
  background: white;
  padding: 30px;
  border-radius: 20px;
  box-shadow: 0 10px 35px rgba(0, 0, 0, 0.1);
  margin-bottom: 30px;
  animation-duration: 0.5s;
}

.tab.active {
  display: block;
  animation: fadeIn 0.5s ease;
}

.tab-content {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 30px;
}

.api-config {
  background: var(--light);
  padding: 25px;
  border-radius: 15px;
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
  border: 1px solid rgba(0,0,0,0.05);
}

.prompt-section {
  background: var(--light);
  padding: 25px;
  border-radius: 15px;
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
  border: 1px solid rgba(0,0,0,0.05);
}

.preview-section {
  grid-column: span 2;
  background: #f9fafb;
  padding: 25px;
  border-radius: 15px;
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
  border: 1px solid rgba(0,0,0,0.05);
}

h2 {
  color: var(--primary);
  font-size: 2.2rem;
  margin-bottom: 25px;
  padding-bottom: 15px;
  border-bottom: 2px solid var(--light-gray);
  display: flex;
  align-items: center;
  gap: 15px;
}

h3 {
  color: var(--primary-dark);
  font-size: 1.6rem;
  margin: 25px 0 20px;
  display: flex;
  align-items: center;
  gap: 12px;
}

label {
  display: block;
  font-weight: 600;
  margin-top: 20px;
  color: var(--dark);
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 1.1rem;
}

input, textarea, select {
  width: 100%;
  padding: 14px 18px;
  margin-top: 10px;
  border: 1px solid #d1d5db;
  border-radius: 12px;
  font-size: 1.1rem;
  transition: all 0.3s ease;
  background: white;
  box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
}

input:focus, textarea:focus, select:focus {
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(108, 99, 255, 0.15);
  outline: none;
}

textarea {
  min-height: 150px;
  resize: vertical;
  line-height: 1.6;
}

button.action {
  background: linear-gradient(135deg, var(--secondary), var(--secondary-dark));
  color: white;
  border: none;
  padding: 16px 30px;
  border-radius: 50px;
  cursor: pointer;
  transition: all 0.3s ease;
  font-size: 1.2rem;
  font-weight: 600;
  margin-top: 25px;
  width: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
  box-shadow: 0 6px 15px rgba(255, 111, 97, 0.3);
  position: relative;
  overflow: hidden;
  z-index: 1;
}

button.action:hover {
  transform: translateY(-5px);
  box-shadow: 0 8px 20px rgba(255, 111, 97, 0.4);
}

button.action:disabled {
  background: linear-gradient(135deg, #bdc3c7, #95a5a6);
  cursor: not-allowed;
  transform: none;
  box-shadow: none;
}

pre {
  background: #1e1e1e;
  color: #d4d4d4;
  padding: 25px;
  border-radius: 15px;
  overflow-x: auto;
  margin-top: 20px;
  white-space: pre-wrap;
  font-family: 'Fira Code', 'Courier New', monospace;
  font-size: 1.05rem;
  line-height: 1.6;
  max-height: 450px;
  overflow-y: auto;
  box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
}

.description-tip {
  background: linear-gradient(135deg, #e0f7fa, #bbdefb);
  padding: 30px;
  border-radius: 20px;
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
  border: 1px solid rgba(33, 150, 243, 0.2);
}

.tip-content {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 30px;
}

.examples {
  background: rgba(255, 255, 255, 0.75);
  padding: 20px;
  border-radius: 15px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
}

.example-title {
  font-weight: 700;
  color: var(--primary-dark);
  margin-bottom: 15px;
  display: flex;
  align-items: center;
  gap: 12px;
  font-size: 1.2rem;
}

.example-content {
  background: white;
  padding: 20px;
  border-radius: 12px;
  margin-top: 15px;
  font-size: 1.05rem;
  line-height: 1.7;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.loading {
  color: var(--primary);
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 15px;
  font-size: 1.1rem;
  padding: 15px;
  background: rgba(108, 99, 255, 0.05);
  border-radius: 10px;
}

.error {
  color: var(--danger);
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 15px;
  font-size: 1.1rem;
  padding: 15px;
  background: rgba(220, 53, 69, 0.05);
  border-radius: 10px;
}

.success {
  color: var(--success);
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 15px;
  font-size: 1.1rem;
  padding: 15px;
  background: rgba(40, 167, 69, 0.05);
  border-radius: 10px;
}

.api-provider-select {
  margin-bottom: 20px;
  padding: 14px;
  border-radius: 12px;
  border: 1px solid #d1d5db;
  width: 100%;
  background: white;
  font-size: 1.1rem;
  box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}

.model-status {
  margin-top: 15px;
  padding: 15px;
  border-radius: 12px;
  font-size: 1.05rem;
}

.progress-container {
  margin: 20px 0;
  background: #edf2f7;
  border-radius: 10px;
  overflow: hidden;
  height: 10px;
}

.progress-bar {
  height: 100%;
  background: linear-gradient(90deg, var(--primary), var(--secondary));
  width: 0%;
  transition: width 0.4s ease;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(25px); }
  to { opacity: 1; transform: translateY(0); }
}

.spinner {
  width: 28px;
  height: 28px;
  border: 4px solid rgba(108, 99, 255, 0.2);
  border-radius: 50%;
  border-top-color: var(--primary);
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

@media (max-width: 992px) {
  .tab-content, .tip-content {
    grid-template-columns: 1fr;
  }
  
  .preview-section {
    grid-column: span 1;
  }
  
  h1 {
    font-size: 2.2rem;
  }
  
  .tabs button {
    padding: 12px 20px;
    font-size: 1.1rem;
  }
}

@media (max-width: 576px) {
  body {
    padding: 15px;
  }
  
  header {
    padding: 20px 15px;
  }
  
  h1 {
    font-size: 1.8rem;
  }
  
  .tab {
    padding: 20px 15px;
  }
  
  h2 {
    font-size: 1.8rem;
  }
  
  h3 {
    font-size: 1.4rem;
  }
}

.character-extra {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 15px;
  margin-top: 15px;
}

.character-extra label {
  margin-top: 0;
}

.world-refinement {
  margin-top: 20px;
  padding: 20px;
  background: #f8f9fa;
  border-radius: 12px;
  border-left: 4px solid var(--primary);
}

.mvu-status {
  margin-top: 20px;
  padding: 20px;
  background: #e8f4fd;
  border-radius: 12px;
  border-left: 4px solid #2196f3;
}

.mvu-status h4 {
  margin-bottom: 15px;
  color: #0d47a1;
  display: flex;
  align-items: center;
  gap: 10px;
}

.mvu-status textarea {
  font-family: monospace;
  min-height: 120px;
}

.tab-indicator {
  position: absolute;
  bottom: 0;
  left: 0;
  height: 4px;
  background: var(--primary);
  border-radius: 2px;
  transition: all 0.3s ease;
}
</style>
</head>
<body>
<div class="container">
  <header>
    <h1>
      <span>📚</span>
      SillyTavern 世界书 & 角色卡生成器
    </h1>
    <p>高效生成完美的世界设定和角色卡片</p>
  </header>

  <div class="tabs">
    <button onclick="showTab('world')" class="tab-button active">
      <span>🌍</span>
      世界书生成
    </button>
    <button onclick="showTab('character')" class="tab-button">
      <span>🎭</span>
      角色卡生成
    </button>
    <div class="tab-indicator" id="tabIndicator"></div>
  </div>

  <div id="world" class="tab active">
    <h2><span>🌍</span> 世界书生成</h2>
    
    <div class="tab-content">
      <div class="api-config">
        <h3><span>⚙️</span> API 配置</h3>
        
        <label>API 提供商:</label>
        <select id="apiProviderWorld" class="api-provider-select" onchange="changeApiProvider('world')">
          <option value="openai">OpenAI</option>
          <option value="custom">自定义API</option>
        </select>
        
        <label>API 地址:</label>
        <input type="text" id="apiUrlWorld" value="https://api.openai.com/v1" readonly>
        
        <label>API Key:</label>
        <input type="password" id="apiKeyWorld" placeholder="输入您的API密钥" oninput="autoFetchModels('world')">
        
        <label>模型:</label>
        <select id="modelWorld"></select>
        
        <div id="modelStatusWorld" class="model-status"></div>
        
        <div class="progress-container">
          <div id="modelProgressWorld" class="progress-bar"></div>
        </div>
      </div>
      
      <div class="prompt-section">
        <h3><span>📝</span> 世界设定</h3>
        
        <label for="worldDesc">
          <span>✏️</span>
          世界观简述:
        </label>
        <textarea id="worldDesc" placeholder="描述您的世界观，包括地理、历史、文化、种族、科技/魔法系统等..." oninput="debouncedPreview('world')"></textarea>
        
        <div class="world-refinement">
          <h4><span>🔍</span> 世界细化选项</h4>
          <label>
            <input type="checkbox" id="refineWithCharacters" checked>
            根据角色卡细化世界观
          </label>
        </div>
        
        <div class="mvu-status">
          <h4><span>📊</span> MVU状态栏生成</h4>
          <label>状态变量描述:</label>
          <textarea id="statusVariables" placeholder="描述需要跟踪的状态变量，例如：角色好感度、世界时间、阵营关系等..."></textarea>
        </div>
        
        <label for="worldFilename">
          <span>📁</span>
          文件名:
        </label>
        <input type="text" id="worldFilename" value="generated_world.json">
      </div>
      
      <div class="preview-section">
        <h3><span>🔍</span> 预览</h3>
        <pre id="worldOutput">输入世界观描述后，预览将显示在这里...</pre>
        
        <button id="generateWorldBtn" class="action" onclick="generateWorldInfo()">
          <span>🚀</span>
          生成并下载世界书 JSON
        </button>
      </div>
    </div>
  </div>

  <div id="character" class="tab">
    <h2><span>🎭</span> 角色卡生成</h2>
    
    <div class="tab-content">
      <div class="api-config">
        <h3><span>⚙️</span> API 配置</h3>
        
        <label>API 提供商:</label>
        <select id="apiProviderChar" class="api-provider-select" onchange="changeApiProvider('character')">
          <option value="openai">OpenAI</option>
          <option value="custom">自定义API</option>
        </select>
        
        <label>API 地址:</label>
        <input type="text" id="apiUrlChar" value="https://api.openai.com/v1" readonly>
        
        <label>API Key:</label>
        <input type="password" id="apiKeyChar" placeholder="输入您的API密钥" oninput="autoFetchModels('character')">
        
        <label>模型:</label>
        <select id="modelChar"></select>
        
        <div id="modelStatusChar" class="model-status"></div>
        
        <div class="progress-container">
          <div id="modelProgressChar" class="progress-bar"></div>
        </div>
      </div>
      
      <div class="prompt-section">
        <h3><span>📝</span> 角色设定</h3>
        
        <label for="charDesc">
          <span>✏️</span>
          角色设定简述:
        </label>
        <textarea id="charDesc" placeholder="描述您的角色，包括姓名、性格、背景、外貌、特殊能力、行为模式等..." oninput="debouncedPreview('character')"></textarea>
        
        <div class="character-extra">
          <div>
            <label for="firstMessage">
              <span>💬</span>
              角色开场白:
            </label>
            <textarea id="firstMessage" placeholder="角色的第一句话，用于对话开始时..."></textarea>
          </div>
          <div>
            <label for="scenario">
              <span>🌆</span>
              场景设定:
            </label>
            <textarea id="scenario" placeholder="角色出现的场景描述..."></textarea>
          </div>
        </div>
        
        <label for="charFilename">
          <span>📁</span>
          文件名:
        </label>
        <input type="text" id="charFilename" value="generated_character.json">
      </div>
      
      <div class="preview-section">
        <h3><span>🔍</span> 预览</h3>
        <pre id="charOutput">输入角色描述后，预览将显示在这里...</pre>
        
        <button id="generateCharBtn" class="action" onclick="generateCharacterCard()">
          <span>🚀</span>
          生成并下载角色卡 JSON
        </button>
      </div>
    </div>
  </div>

  <div class="description-tip">
    <h3><span>📝</span> 使用提示与示例</h3>
    
    <div class="tip-content">
      <div class="examples">
        <div class="example-title">
          <span>🌍</span>
          世界观示例:
        </div>
        <div class="example-content">
          <p><strong>奇幻蒸汽朋克世界</strong></p>
          <p>一个结合了魔法与蒸汽科技的世界，主要大陆由四个帝国统治。北方帝国以强大的机械技术闻名，南方帝国精通元素魔法，西方群岛是海盗和商人的家园，东方沙漠有古老的遗迹和神秘生物。魔法能量（称为"以太"）驱动着巨大的蒸汽机械，但过度使用会导致"以太污染"。世界正面临资源枯竭危机，各国关系紧张。</p>
        </div>
        
        <div class="example-title">
          <span>🎭</span>
          角色卡示例:
        </div>
        <div class="example-content">
          <p><strong>莉亚·风语者</strong></p>
          <p>25岁的半精灵游侠，性格独立而谨慎，有着银白色长发和翠绿眼睛。出生在森林边境村庄，家人被帝国士兵杀害后成为流浪者。擅长弓箭和追踪，能与动物沟通。对帝国充满仇恨但保持理性，目标是揭露帝国对森林的破坏计划。说话简洁直接，行动前会仔细观察环境。</p>
          <p><strong>开场白:</strong> "我注意到你跟踪我很久了。说吧，你是帝国派来的探子，还是只是迷路的旅人？"</p>
        </div>
        
        <div class="example-title">
          <span>📊</span>
          MVU状态栏示例:
        </div>
        <div class="example-content">
          <pre>
💖 好感度: &lt;%- SafeGetValue(msg_data.理.好感度) %&gt;&lt;br&gt;
🌍 世界时间: &lt;%- SafeGetValue(msg_data.世界.时间) %&gt;&lt;br&gt;
⚔️ 阵营关系: &lt;%- SafeGetValue(msg_data.阵营.关系) %&gt;&lt;br&gt;
💧 以太污染: &lt;%- SafeGetValue(msg_data.世界.以太污染) %&gt;&lt;br&gt;</pre>
        </div>
      </div>
      
      <div>
        <div class="example-title">
          <span>💡</span>
          使用指南:
        </div>
        <div class="example-content">
          <p><strong>1. 配置API</strong></p>
          <p>• 选择API提供商（OpenAI或自定义）</p>
          <p>• 输入正确的API地址和密钥</p>
          <p>• 系统会自动加载可用模型</p>
          
          <p><strong>2. 角色卡生成</strong></p>
          <p>• 填写角色设定简述</p>
          <p>• 添加角色开场白和场景设定</p>
          <p>• 生成角色卡JSON文件</p>
          
          <p><strong>3. 世界书生成</strong></p>
          <p>• 填写世界观简述</p>
          <p>• 使用角色卡细化世界观（可选）</p>
          <p>• 添加MVU状态栏变量</p>
          <p>• 生成世界书JSON文件</p>
        </div>
        
        <div class="example-title">
          <span>⚠️</span>
          注意事项:
        </div>
        <div class="example-content">
          <p>• 角色开场白会直接影响角色在对话中的第一句话</p>
          <p>• 世界书生成可以选择根据角色卡细化世界观</p>
          <p>• MVU状态栏变量需要描述清楚需要跟踪的状态</p>
          <p>• 生成过程中请勿关闭页面</p>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// API提供商配置
const apiProviders = {
  openai: {
    baseUrl: "https://api.openai.com/v1",
    modelsEndpoint: "/models",
    chatEndpoint: "/chat/completions",
    authHeader: "Bearer",
    defaultModel: "gpt-3.5-turbo"
  },
  custom: {
    baseUrl: "",
    modelsEndpoint: "/models",
    chatEndpoint: "/chat/completions",
    authHeader: "Bearer",
    defaultModel: ""
  }
};

// 模板定义
const worldTemplate = {
  "world_name": "生成的世界名称",
  "description": "世界的总体描述",
  "history": "世界的历史背景",
  "geography": "地理环境描述",
  "culture": "主要文化特征",
  "races": ["种族1", "种族2", "种族3"],
  "magic_system": "魔法或科技系统",
  "politics": "政治结构",
  "key_locations": {
    "location1": "重要地点1的描述",
    "location2": "重要地点2的描述"
  },
  "important_events": ["事件1", "事件2"],
  "creator_notes": "创建者备注"
};

const characterTemplate = {
  "name": "角色名称",
  "description": "角色简要描述",
  "personality": "性格特点",
  "appearance": "外貌特征",
  "background": "背景故事",
  "motivations": "动机和目标",
  "abilities": ["能力1", "能力2"],
  "relationships": {
    "relationship1": "关系1描述",
    "relationship2": "关系2描述"
  },
  "first_mes": "角色第一条消息示例",
  "scenario": "场景设定",
  "mes_example": "对话示例",
  "creator_notes": "创建者备注"
};

// 状态管理
const state = {
  world: {
    generating: false,
    previewing: false,
    lastRequest: null
  },
  character: {
    generating: false,
    previewing: false,
    lastRequest: null
  }
};

// DOM加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
  // 设置默认模型
  const modelWorld = document.getElementById('modelWorld');
  const optionWorld = document.createElement('option');
  optionWorld.value = apiProviders.openai.defaultModel;
  optionWorld.textContent = apiProviders.openai.defaultModel;
  modelWorld.appendChild(optionWorld);
  
  const modelChar = document.getElementById('modelChar');
  const optionChar = document.createElement('option');
  optionChar.value = apiProviders.openai.defaultModel;
  optionChar.textContent = apiProviders.openai.defaultModel;
  modelChar.appendChild(optionChar);
  
  // 初始状态
  document.getElementById('worldOutput').textContent = JSON.stringify(worldTemplate, null, 2);
  document.getElementById('charOutput').textContent = JSON.stringify(characterTemplate, null, 2);
  
  // 设置进度条
  setProgress('world', 0);
  setProgress('character', 0);
  
  // 初始化标签页指示器
  updateTabIndicator();
});

// 切换标签页 - 已修复
function showTab(id) {
  // 隐藏所有标签页
  document.querySelectorAll('.tab').forEach(tab => {
    tab.classList.remove('active');
  });
  
  // 显示选中的标签页
  document.getElementById(id).classList.add('active');
  
  // 更新标签按钮状态
  document.querySelectorAll('.tab-button').forEach(button => {
    button.classList.remove('active');
  });
  
  // 设置当前按钮为激活状态
  const activeButton = Array.from(document.querySelectorAll('.tab-button'))
    .find(button => button.textContent.includes(id === 'world' ? '世界书' : '角色卡'));
  
  if (activeButton) {
    activeButton.classList.add('active');
  }
  
  // 更新标签指示器位置
  updateTabIndicator();
}

// 更新标签页指示器位置
function updateTabIndicator() {
  const activeButton = document.querySelector('.tab-button.active');
  const indicator = document.getElementById('tabIndicator');
  
  if (activeButton && indicator) {
    const buttonRect = activeButton.getBoundingClientRect();
    const tabsRect = document.querySelector('.tabs').getBoundingClientRect();
    
    indicator.style.width = `${buttonRect.width}px`;
    indicator.style.left = `${buttonRect.left - tabsRect.left}px`;
  }
}

// 切换API提供商
function changeApiProvider(type) {
  const tabType = type === 'world' ? 'World' : 'Char';
  const providerSelect = document.getElementById(`apiProvider${tabType}`);
  const apiUrlInput = document.getElementById(`apiUrl${tabType}`);
  
  if (providerSelect.value === 'openai') {
    apiUrlInput.value = apiProviders.openai.baseUrl;
    apiUrlInput.readOnly = true;
  } else {
    apiUrlInput.value = '';
    apiUrlInput.readOnly = false;
    apiUrlInput.placeholder = "输入您的API基础地址，如: https://ai.nyabit.com/v1";
  }
}

// 设置进度条
function setProgress(type, percent) {
  const progressBar = document.getElementById(`modelProgress${type === 'world' ? 'World' : 'Char'}`);
  if (progressBar) {
    progressBar.style.width = `${percent}%`;
  }
}

// 自动获取模型
async function autoFetchModels(type) {
  const tabType = type === 'world' ? 'World' : 'Char';
  const providerSelect = document.getElementById(`apiProvider${tabType}`);
  const provider = apiProviders[providerSelect.value];
  
  const apiUrlInput = document.getElementById(`apiUrl${tabType}`);
  let baseUrl = provider.baseUrl;
  
  // 如果是自定义API，使用用户输入的URL
  if (providerSelect.value === 'custom') {
    baseUrl = apiUrlInput.value.trim().replace(/\/+$/, '');
    if (!baseUrl) return;
  }

  const apiKey = document.getElementById(`apiKey${tabType}`).value.trim();
  const select = document.getElementById(`model${tabType}`);
  const statusElement = document.getElementById(`modelStatus${tabType}`);
  
  if (!apiKey) {
    statusElement.innerHTML = `<span class="error">⚠️ 请输入API密钥</span>`;
    return;
  }
  
  // 显示加载状态
  statusElement.innerHTML = `<div class="loading"><div class="spinner"></div> 正在获取模型列表...</div>`;
  
  // 模拟进度条
  let progress = 0;
  const progressInterval = setInterval(() => {
    progress = Math.min(progress + 5, 90);
    setProgress(type, progress);
  }, 200);
  
  try {
    const modelsUrl = baseUrl + provider.modelsEndpoint;
    const resp = await fetchWithTimeout(modelsUrl, {
      method: 'GET',
      headers: {
        'Authorization': `${provider.authHeader} ${apiKey}`,
        'Content-Type': 'application/json'
      }
    }, 10000); // 10秒超时
    
    if (!resp.ok) {
      throw new Error(`API请求失败: ${resp.status} ${resp.statusText}`);
    }
    
    const data = await resp.json();
    
    // 处理不同的API响应格式
    let models = [];
    if (Array.isArray(data)) {
      models = data;
    } else if (data.data && Array.isArray(data.data)) {
      models = data.data;
    } else {
      throw new Error('模型列表格式不符合预期');
    }
    
    if (models.length === 0) {
      throw new Error('没有可用的模型');
    }
    
    // 清空现有选项
    select.innerHTML = '';
    
    // 添加模型选项
    models.forEach(m => {
      const modelId = m.id || m;
      const o = document.createElement('option');
      o.value = modelId;
      o.textContent = modelId;
      select.appendChild(o);
    });
    
    statusElement.innerHTML = `<span class="success">✅ 模型列表加载完成 (${models.length}个模型)</span>`;
    setProgress(type, 100);
    
  } catch (e) {
    console.error('获取模型列表错误:', e);
    statusElement.innerHTML = `<span class="error">❌ 错误: ${e.message}</span>`;
    setProgress(type, 0);
    
    // 添加一个默认选项
    select.innerHTML = '';
    const defaultOption = document.createElement('option');
    defaultOption.value = '';
    defaultOption.textContent = '无法获取模型列表';
    select.appendChild(defaultOption);
  } finally {
    clearInterval(progressInterval);
  }
}

// 带超时的fetch函数
function fetchWithTimeout(url, options, timeout = 8000) {
  return Promise.race([
    fetch(url, options),
    new Promise((_, reject) =>
      setTimeout(() => reject(new Error('请求超时')), timeout)
    )
  ]);
}

// 防抖函数
function debounce(func, wait) {
  let timeout;
  return function(...args) {
    clearTimeout(timeout);
    timeout = setTimeout(() => func.apply(this, args), wait);
  }
}

// 实时预览
const debouncedPreview = debounce(async function(type) {
  if (type === 'world') await previewWorld();
  else if (type === 'character') await previewChar();
}, 1500); // 1.5秒防抖

// 处理JSON解析错误
function safeJsonParse(str) {
  try {
    return JSON.parse(str);
  } catch (e) {
    // 尝试修复常见的JSON错误
    try {
      // 尝试提取第一个有效的JSON对象
      const jsonMatch = str.match(/{[\s\S]*}|\[[\s\S]*]/);
      if (jsonMatch) {
        return JSON.parse(jsonMatch[0]);
      }
      
      // 尝试修复缺少引号的问题
      const fixedStr = str
        .replace(/(\w+):/g, '"$1":')  // 为键添加引号
        .replace(/:(\w+)([,}])/g, ':"$1"$2')  // 为字符串值添加引号
        .replace(/:([^"{\[\d][^,}\]\s]*)/g, ':"$1"'); // 为未加引号的值添加引号
        
      return JSON.parse(fixedStr);
    } catch (fixError) {
      console.error('JSON修复失败:', fixError);
      return {
        error: 'JSON解析失败',
        originalContent: str,
        errorMessage: e.message
      };
    }
  }
}

// 带取消功能的API请求
async function makeApiRequest(type, prompt, signal) {
  const tabType = type === 'world' ? 'World' : 'Char';
  const providerSelect = document.getElementById(`apiProvider${tabType}`);
  const provider = apiProviders[providerSelect.value];
  
  let baseUrl = provider.baseUrl;
  if (providerSelect.value === 'custom') {
    baseUrl = document.getElementById(`apiUrl${tabType}`).value.trim().replace(/\/+$/, '');
  }
  
  const apiUrl = baseUrl + provider.chatEndpoint;
  const apiKey = document.getElementById(`apiKey${tabType}`).value.trim();
  const model = document.getElementById(`model${tabType}`).value;
  
  if (!model) {
    throw new Error('请选择模型');
  }
  
  // 构建请求体
  const requestBody = {
    model: model,
    messages: [{role: 'user', content: prompt}],
    temperature: 0.7,
    response_format: { type: "json_object" } // 要求API返回JSON格式
  };
  
  try {
    const response = await fetchWithTimeout(apiUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `${provider.authHeader} ${apiKey}`
      },
      body: JSON.stringify(requestBody),
      signal: signal // 传递AbortSignal
    }, 15000); // 15秒超时
    
    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(`API错误: ${response.status} - ${errorData.error?.message || response.statusText}`);
    }
    
    const data = await response.json();
    
    // 处理不同API的返回结构
    if (providerSelect.value === 'openai') {
      return data.choices?.[0]?.message?.content;
    } else {
      // 自定义API可能返回不同结构
      return data.result || data.response || data.choices?.[0]?.text || data.choices?.[0]?.message?.content;
    }
  } catch (error) {
    if (error.name === 'AbortError') {
      console.log('请求被取消');
      return null;
    }
    console.error('API请求错误:', error);
    throw error;
  }
}

// 生成MVU状态栏
function generateMvuStatus(variablesDesc) {
  if (!variablesDesc) return '';
  
  // 提取变量并生成EJS代码
  const variables = variablesDesc.split(/[\n,，]/).filter(v => v.trim() !== '');
  
  let ejsCode = `<%
  if (runType == 'render')
  {
      function SafeGetValue(value, defaultValue = "") {
          // 如果值不存在，返回默认值
          if (value === undefined || value === null) {
              return defaultValue;
          }
          // 如果是数组，取第一个元素
          if (Array.isArray(value)) {
              return value.length !== 0 ? value : defaultValue;
          }
          // 否则直接返回该值本身
          return value;
      }
      const data = window.TavernHelper.getVariables({type: 'message', message_id: message_id});
      const msg_data = data.display_data;
  %>
  `;
  
  variables.forEach((variable, index) => {
    const varName = variable.trim();
    if (!varName) return;
    
    // 为变量生成图标和标签
    const icons = ['💖', '🌍', '⚔️', '💧', '🔮', '🕒', '🔋', '🔭', '📜', '⚙️'];
    const icon = icons[index % icons.length];
    
    ejsCode += `${icon} ${varName}: <%- SafeGetValue(msg_data.${varName.replace(/\s+/g, '_')}) %><br>\n`;
  });
  
  ejsCode += `<%}%>`;
  
  return ejsCode;
}

// 预览世界书
async function previewWorld() {
  if (state.world.previewing) return;
  
  const desc = document.getElementById('worldDesc').value.trim();
  const output = document.getElementById('worldOutput');
  
  if (!desc) {
    output.textContent = "请输入世界观描述";
    return;
  }
  
  state.world.previewing = true;
  const controller = new AbortController();
  state.world.lastRequest = controller;
  
  try {
    output.textContent = "正在生成预览...";
    document.getElementById('generateWorldBtn').disabled = true;
    
    // 改进的提示模板
    const prompt = `你是一个世界书生成专家，根据以下描述创建一个奇幻世界的详细设定。只输出严格符合以下JSON结构的对象，不要任何额外文字。使用中文描述。
    
    参考结构：
    ${JSON.stringify(worldTemplate, null, 2)}
    
    世界描述：${desc}`;
    
    const content = await makeApiRequest('world', prompt, controller.signal);
    
    if (content === null) return; // 请求被取消
    
    // 使用安全的JSON解析
    const jsonData = safeJsonParse(content);
    output.textContent = JSON.stringify(jsonData, null, 2);
  } catch (err) {
    output.textContent = `预览失败: ${err.message}\n\n请检查API设置和网络连接。`;
  } finally {
    state.world.previewing = false;
    document.getElementById('generateWorldBtn').disabled = false;
  }
}

// 预览角色卡
async function previewChar() {
  if (state.character.previewing) return;
  
  const desc = document.getElementById('charDesc').value.trim();
  const output = document.getElementById('charOutput');
  
  if (!desc) {
    output.textContent = "请输入角色描述";
    return;
  }
  
  state.character.previewing = true;
  const controller = new AbortController();
  state.character.lastRequest = controller;
  
  try {
    output.textContent = "正在生成预览...";
    document.getElementById('generateCharBtn').disabled = true;
    
    // 改进的提示模板
    const prompt = `你是一个角色卡生成专家，根据以下描述创建一个详细的角色设定。只输出严格符合以下JSON结构的对象，不要任何额外文字。使用中文描述。
    
    参考结构：
    ${JSON.stringify(characterTemplate, null, 2)}
    
    角色描述：${desc}`;
    
    const content = await makeApiRequest('character', prompt, controller.signal);
    
    if (content === null) return; // 请求被取消
    
    // 使用安全的JSON解析
    const jsonData = safeJsonParse(content);
    output.textContent = JSON.stringify(jsonData, null, 2);
  } catch (err) {
    output.textContent = `预览失败: ${err.message}\n\n请检查API设置和网络连接。`;
  } finally {
    state.character.previewing = false;
    document.getElementById('generateCharBtn').disabled = false;
  }
}

// 生成世界书
async function generateWorldInfo() {
  if (state.world.generating) return;
  
  const desc = document.getElementById('worldDesc').value.trim();
  const filename = document.getElementById('worldFilename').value;
  const output = document.getElementById('worldOutput');
  const refineWithCharacters = document.getElementById('refineWithCharacters').checked;
  const statusVariables = document.getElementById('statusVariables').value.trim();
  
  if (!desc) {
    output.textContent = "请输入世界观描述";
    return;
  }
  
  state.world.generating = true;
  const controller = new AbortController();
  
  // 取消之前的预览请求
  if (state.world.lastRequest) {
    state.world.lastRequest.abort();
  }
  
  try {
    output.textContent = "正在生成完整世界书...";
    document.getElementById('generateWorldBtn').disabled = true;
    document.getElementById('generateWorldBtn').innerHTML = `<div class="spinner"></div> 生成中...`;
    
    // 更详细的生成提示
    let prompt = `你是一个世界书生成专家，根据以下描述创建一个奇幻世界的详细设定。输出一个详细的JSON对象，包含以下字段：world_name, description, history, geography, culture, races, magic_system, politics, key_locations, important_events, creator_notes。使用中文描述。
    
    世界描述：${desc}`;
    
    // 如果启用了角色卡细化
    if (refineWithCharacters) {
      const charData = localStorage.getItem('characterData');
      if (charData) {
        const charJson = JSON.parse(charData);
        prompt += `\n\n基于以下角色卡细化世界观：\n${JSON.stringify(charJson, null, 2)}`;
      }
    }
    
    const content = await makeApiRequest('world', prompt, controller.signal);
    
    if (content === null) return; // 请求被取消
    
    // 使用安全的JSON解析
    let jsonData = safeJsonParse(content);
    
    // 添加MVU状态栏
    if (statusVariables) {
      jsonData.mvu_status_bar = generateMvuStatus(statusVariables);
    }
    
    // 添加世界细化结构
    jsonData.world_structure = {
      "1. 接收与静默分析": "接收用户发送的全部文本",
      "2. 智能实体提取": {
        "地点实体": "识别地理名词并创建总览和详情条目",
        "组织实体": "识别群体名词并创建总览和详情条目",
        "人物实体": "识别人物和种族并创建总览和详情条目",
        "规则实体": "识别世界运作规律并创建核心规则条目",
        "事件实体": "识别历史事件并创建时间线条目",
        "物品实体": "识别重要物品和技术并创建条目"
      },
      "3. 构建层级结构": "创建包含总览条目和详情条目的层级结构",
      "4. 填充与生成内容": "将描述填充到对应条目中"
    };
    
    downloadFile(filename, JSON.stringify(jsonData, null, 2));
    output.textContent = JSON.stringify(jsonData, null, 2);
  } catch (err) {
    output.textContent = `生成失败: ${err.message}\n\n请检查API设置和网络连接。`;
  } finally {
    state.world.generating = false;
    document.getElementById('generateWorldBtn').disabled = false;
    document.getElementById('generateWorldBtn').innerHTML = `<span>🚀</span> 生成并下载世界书 JSON`;
  }
}

// 生成角色卡
async function generateCharacterCard() {
  if (state.character.generating) return;
  
  const desc = document.getElementById('charDesc').value.trim();
  const filename = document.getElementById('charFilename').value;
  const output = document.getElementById('charOutput');
  const firstMessage = document.getElementById('firstMessage').value.trim();
  const scenario = document.getElementById('scenario').value.trim();
  
  if (!desc) {
    output.textContent = "请输入角色描述";
    return;
  }
  
  state.character.generating = true;
  const controller = new AbortController();
  
  // 取消之前的预览请求
  if (state.character.lastRequest) {
    state.character.lastRequest.abort();
  }
  
  try {
    output.textContent = "正在生成完整角色卡...";
    document.getElementById('generateCharBtn').disabled = true;
    document.getElementById('generateCharBtn').innerHTML = `<div class="spinner"></div> 生成中...`;
    
    // 更详细的生成提示
    let prompt = `你是一个角色卡生成专家，根据以下描述创建一个详细的角色设定。输出一个详细的JSON对象，包含以下字段：name, description, personality, appearance, background, motivations, abilities, relationships, first_mes, scenario, mes_example, creator_notes。使用中文描述。
    
    角色描述：${desc}`;
    
    // 添加开场白和场景设定
    if (firstMessage) {
      prompt += `\n角色开场白：${firstMessage}`;
    }
    if (scenario) {
      prompt += `\n场景设定：${scenario}`;
    }
    
    const content = await makeApiRequest('character', prompt, controller.signal);
    
    if (content === null) return; // 请求被取消
    
    // 使用安全的JSON解析
    const jsonData = safeJsonParse(content);
    
    // 保存角色数据用于世界书细化
    localStorage.setItem('characterData', JSON.stringify(jsonData));
    
    downloadFile(filename, JSON.stringify(jsonData, null, 2));
    output.textContent = JSON.stringify(jsonData, null, 2);
  } catch (err) {
    output.textContent = `生成失败: ${err.message}\n\n请检查API设置和网络连接。`;
  } finally {
    state.character.generating = false;
    document.getElementById('generateCharBtn').disabled = false;
    document.getElementById('generateCharBtn').innerHTML = `<span>🚀</span> 生成并下载角色卡 JSON`;
  }
}

// 下载文件
function downloadFile(filename, content) {
  const blob = new Blob([content], {type: 'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);
}
</script>
</body>
</html>