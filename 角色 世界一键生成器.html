<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ“š SillyTavern ä¸–ç•Œä¹¦ & è§’è‰²å¡ç”Ÿæˆå™¨</title>
<style>
:root {
  --primary: #6c63ff;
  --primary-dark: #574fd6;
  --secondary: #ff6f61;
  --secondary-dark: #e85a50;
  --light: #f8f9fa;
  --dark: #333;
  --success: #28a745;
  --warning: #ffc107;
  --danger: #dc3545;
  --gray: #6c757d;
  --light-gray: #e9ecef;
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  line-height: 1.6;
  color: var(--dark);
  background: linear-gradient(135deg, #f0f2f5, #e4e7eb);
  padding: 20px;
  min-height: 100vh;
}

.container {
  max-width: 1200px;
  margin: 0 auto;
}

header {
  text-align: center;
  margin-bottom: 30px;
  padding: 25px;
  background: rgba(255, 255, 255, 0.9);
  border-radius: 20px;
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
  position: relative;
  overflow: hidden;
}

header::before {
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 5px;
  background: linear-gradient(90deg, var(--primary), var(--secondary));
}

h1 {
  color: var(--primary);
  font-size: 2.8rem;
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 15px;
  text-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.tabs {
  display: flex;
  justify-content: center;
  margin-bottom: 30px;
  gap: 15px;
  flex-wrap: wrap;
}

.tabs button {
  background: var(--primary);
  color: white;
  border: none;
  padding: 15px 30px;
  border-radius: 50px;
  cursor: pointer;
  transition: all 0.3s ease;
  font-size: 1.2rem;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 10px;
  box-shadow: 0 4px 12px rgba(108, 99, 255, 0.3);
  position: relative;
  overflow: hidden;
  z-index: 1;
}

.tabs button:hover {
  background: var(--primary-dark);
  transform: translateY(-5px);
  box-shadow: 0 6px 15px rgba(108, 99, 255, 0.4);
}

.tab {
  display: none;
  background: white;
  padding: 30px;
  border-radius: 20px;
  box-shadow: 0 10px 35px rgba(0, 0, 0, 0.1);
  margin-bottom: 30px;
  animation-duration: 0.5s;
}

.tab.active {
  display: block;
  animation: fadeIn 0.5s ease;
}

.tab-content {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 30px;
}

.api-config {
  background: var(--light);
  padding: 25px;
  border-radius: 15px;
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
  border: 1px solid rgba(0,0,0,0.05);
}

.prompt-section {
  background: var(--light);
  padding: 25px;
  border-radius: 15px;
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
  border: 1px solid rgba(0,0,0,0.05);
}

.preview-section {
  grid-column: span 2;
  background: #f9fafb;
  padding: 25px;
  border-radius: 15px;
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
  border: 1px solid rgba(0,0,0,0.05);
}

h2 {
  color: var(--primary);
  font-size: 2.2rem;
  margin-bottom: 25px;
  padding-bottom: 15px;
  border-bottom: 2px solid var(--light-gray);
  display: flex;
  align-items: center;
  gap: 15px;
}

h3 {
  color: var(--primary-dark);
  font-size: 1.6rem;
  margin: 25px 0 20px;
  display: flex;
  align-items: center;
  gap: 12px;
}

label {
  display: block;
  font-weight: 600;
  margin-top: 20px;
  color: var(--dark);
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 1.1rem;
}

input, textarea, select {
  width: 100%;
  padding: 14px 18px;
  margin-top: 10px;
  border: 1px solid #d1d5db;
  border-radius: 12px;
  font-size: 1.1rem;
  transition: all 0.3s ease;
  background: white;
  box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
}

input:focus, textarea:focus, select:focus {
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(108, 99, 255, 0.15);
  outline: none;
}

textarea {
  min-height: 150px;
  resize: vertical;
  line-height: 1.6;
}

button.action {
  background: linear-gradient(135deg, var(--secondary), var(--secondary-dark));
  color: white;
  border: none;
  padding: 16px 30px;
  border-radius: 50px;
  cursor: pointer;
  transition: all 0.3s ease;
  font-size: 1.2rem;
  font-weight: 600;
  margin-top: 25px;
  width: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
  box-shadow: 0 6px 15px rgba(255, 111, 97, 0.3);
  position: relative;
  overflow: hidden;
  z-index: 1;
}

button.action:hover {
  transform: translateY(-5px);
  box-shadow: 0 8px 20px rgba(255, 111, 97, 0.4);
}

button.action:disabled {
  background: linear-gradient(135deg, #bdc3c7, #95a5a6);
  cursor: not-allowed;
  transform: none;
  box-shadow: none;
}

pre {
  background: #1e1e1e;
  color: #d4d4d4;
  padding: 25px;
  border-radius: 15px;
  overflow-x: auto;
  margin-top: 20px;
  white-space: pre-wrap;
  font-family: 'Fira Code', 'Courier New', monospace;
  font-size: 1.05rem;
  line-height: 1.6;
  max-height: 450px;
  overflow-y: auto;
  box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
}

.description-tip {
  background: linear-gradient(135deg, #e0f7fa, #bbdefb);
  padding: 30px;
  border-radius: 20px;
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
  border: 1px solid rgba(33, 150, 243, 0.2);
}

.tip-content {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 30px;
}

.examples {
  background: rgba(255, 255, 255, 0.75);
  padding: 20px;
  border-radius: 15px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
}

.example-title {
  font-weight: 700;
  color: var(--primary-dark);
  margin-bottom: 15px;
  display: flex;
  align-items: center;
  gap: 12px;
  font-size: 1.2rem;
}

.example-content {
  background: white;
  padding: 20px;
  border-radius: 12px;
  margin-top: 15px;
  font-size: 1.05rem;
  line-height: 1.7;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.loading {
  color: var(--primary);
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 15px;
  font-size: 1.1rem;
  padding: 15px;
  background: rgba(108, 99, 255, 0.05);
  border-radius: 10px;
}

.error {
  color: var(--danger);
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 15px;
  font-size: 1.1rem;
  padding: 15px;
  background: rgba(220, 53, 69, 0.05);
  border-radius: 10px;
}

.success {
  color: var(--success);
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 15px;
  font-size: 1.1rem;
  padding: 15px;
  background: rgba(40, 167, 69, 0.05);
  border-radius: 10px;
}

.api-provider-select {
  margin-bottom: 20px;
  padding: 14px;
  border-radius: 12px;
  border: 1px solid #d1d5db;
  width: 100%;
  background: white;
  font-size: 1.1rem;
  box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}

.model-status {
  margin-top: 15px;
  padding: 15px;
  border-radius: 12px;
  font-size: 1.05rem;
}

.progress-container {
  margin: 20px 0;
  background: #edf2f7;
  border-radius: 10px;
  overflow: hidden;
  height: 10px;
}

.progress-bar {
  height: 100%;
  background: linear-gradient(90deg, var(--primary), var(--secondary));
  width: 0%;
  transition: width 0.4s ease;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(25px); }
  to { opacity: 1; transform: translateY(0); }
}

.spinner {
  width: 28px;
  height: 28px;
  border: 4px solid rgba(108, 99, 255, 0.2);
  border-radius: 50%;
  border-top-color: var(--primary);
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

@media (max-width: 992px) {
  .tab-content, .tip-content {
    grid-template-columns: 1fr;
  }
  
  .preview-section {
    grid-column: span 1;
  }
  
  h1 {
    font-size: 2.2rem;
  }
  
  .tabs button {
    padding: 12px 20px;
    font-size: 1.1rem;
  }
}

@media (max-width: 576px) {
  body {
    padding: 15px;
  }
  
  header {
    padding: 20px 15px;
  }
  
  h1 {
    font-size: 1.8rem;
  }
  
  .tab {
    padding: 20px 15px;
  }
  
  h2 {
    font-size: 1.8rem;
  }
  
  h3 {
    font-size: 1.4rem;
  }
}

.character-extra {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 15px;
  margin-top: 15px;
}

.character-extra label {
  margin-top: 0;
}

.world-refinement {
  margin-top: 20px;
  padding: 20px;
  background: #f8f9fa;
  border-radius: 12px;
  border-left: 4px solid var(--primary);
}

.mvu-status {
  margin-top: 20px;
  padding: 20px;
  background: #e8f4fd;
  border-radius: 12px;
  border-left: 4px solid #2196f3;
}

.mvu-status h4 {
  margin-bottom: 15px;
  color: #0d47a1;
  display: flex;
  align-items: center;
  gap: 10px;
}

.mvu-status textarea {
  font-family: monospace;
  min-height: 120px;
}

.tab-indicator {
  position: absolute;
  bottom: 0;
  left: 0;
  height: 4px;
  background: var(--primary);
  border-radius: 2px;
  transition: all 0.3s ease;
}
</style>
</head>
<body>
<div class="container">
  <header>
    <h1>
      <span>ğŸ“š</span>
      SillyTavern ä¸–ç•Œä¹¦ & è§’è‰²å¡ç”Ÿæˆå™¨
    </h1>
    <p>é«˜æ•ˆç”Ÿæˆå®Œç¾çš„ä¸–ç•Œè®¾å®šå’Œè§’è‰²å¡ç‰‡</p>
  </header>

  <div class="tabs">
    <button onclick="showTab('world')" class="tab-button active">
      <span>ğŸŒ</span>
      ä¸–ç•Œä¹¦ç”Ÿæˆ
    </button>
    <button onclick="showTab('character')" class="tab-button">
      <span>ğŸ­</span>
      è§’è‰²å¡ç”Ÿæˆ
    </button>
    <div class="tab-indicator" id="tabIndicator"></div>
  </div>

  <div id="world" class="tab active">
    <h2><span>ğŸŒ</span> ä¸–ç•Œä¹¦ç”Ÿæˆ</h2>
    
    <div class="tab-content">
      <div class="api-config">
        <h3><span>âš™ï¸</span> API é…ç½®</h3>
        
        <label>API æä¾›å•†:</label>
        <select id="apiProviderWorld" class="api-provider-select" onchange="changeApiProvider('world')">
          <option value="openai">OpenAI</option>
          <option value="custom">è‡ªå®šä¹‰API</option>
        </select>
        
        <label>API åœ°å€:</label>
        <input type="text" id="apiUrlWorld" value="https://api.openai.com/v1" readonly>
        
        <label>API Key:</label>
        <input type="password" id="apiKeyWorld" placeholder="è¾“å…¥æ‚¨çš„APIå¯†é’¥" oninput="autoFetchModels('world')">
        
        <label>æ¨¡å‹:</label>
        <select id="modelWorld"></select>
        
        <div id="modelStatusWorld" class="model-status"></div>
        
        <div class="progress-container">
          <div id="modelProgressWorld" class="progress-bar"></div>
        </div>
      </div>
      
      <div class="prompt-section">
        <h3><span>ğŸ“</span> ä¸–ç•Œè®¾å®š</h3>
        
        <label for="worldDesc">
          <span>âœï¸</span>
          ä¸–ç•Œè§‚ç®€è¿°:
        </label>
        <textarea id="worldDesc" placeholder="æè¿°æ‚¨çš„ä¸–ç•Œè§‚ï¼ŒåŒ…æ‹¬åœ°ç†ã€å†å²ã€æ–‡åŒ–ã€ç§æ—ã€ç§‘æŠ€/é­”æ³•ç³»ç»Ÿç­‰..." oninput="debouncedPreview('world')"></textarea>
        
        <div class="world-refinement">
          <h4><span>ğŸ”</span> ä¸–ç•Œç»†åŒ–é€‰é¡¹</h4>
          <label>
            <input type="checkbox" id="refineWithCharacters" checked>
            æ ¹æ®è§’è‰²å¡ç»†åŒ–ä¸–ç•Œè§‚
          </label>
        </div>
        
        <div class="mvu-status">
          <h4><span>ğŸ“Š</span> MVUçŠ¶æ€æ ç”Ÿæˆ</h4>
          <label>çŠ¶æ€å˜é‡æè¿°:</label>
          <textarea id="statusVariables" placeholder="æè¿°éœ€è¦è·Ÿè¸ªçš„çŠ¶æ€å˜é‡ï¼Œä¾‹å¦‚ï¼šè§’è‰²å¥½æ„Ÿåº¦ã€ä¸–ç•Œæ—¶é—´ã€é˜µè¥å…³ç³»ç­‰..."></textarea>
        </div>
        
        <label for="worldFilename">
          <span>ğŸ“</span>
          æ–‡ä»¶å:
        </label>
        <input type="text" id="worldFilename" value="generated_world.json">
      </div>
      
      <div class="preview-section">
        <h3><span>ğŸ”</span> é¢„è§ˆ</h3>
        <pre id="worldOutput">è¾“å…¥ä¸–ç•Œè§‚æè¿°åï¼Œé¢„è§ˆå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</pre>
        
        <button id="generateWorldBtn" class="action" onclick="generateWorldInfo()">
          <span>ğŸš€</span>
          ç”Ÿæˆå¹¶ä¸‹è½½ä¸–ç•Œä¹¦ JSON
        </button>
      </div>
    </div>
  </div>

  <div id="character" class="tab">
    <h2><span>ğŸ­</span> è§’è‰²å¡ç”Ÿæˆ</h2>
    
    <div class="tab-content">
      <div class="api-config">
        <h3><span>âš™ï¸</span> API é…ç½®</h3>
        
        <label>API æä¾›å•†:</label>
        <select id="apiProviderChar" class="api-provider-select" onchange="changeApiProvider('character')">
          <option value="openai">OpenAI</option>
          <option value="custom">è‡ªå®šä¹‰API</option>
        </select>
        
        <label>API åœ°å€:</label>
        <input type="text" id="apiUrlChar" value="https://api.openai.com/v1" readonly>
        
        <label>API Key:</label>
        <input type="password" id="apiKeyChar" placeholder="è¾“å…¥æ‚¨çš„APIå¯†é’¥" oninput="autoFetchModels('character')">
        
        <label>æ¨¡å‹:</label>
        <select id="modelChar"></select>
        
        <div id="modelStatusChar" class="model-status"></div>
        
        <div class="progress-container">
          <div id="modelProgressChar" class="progress-bar"></div>
        </div>
      </div>
      
      <div class="prompt-section">
        <h3><span>ğŸ“</span> è§’è‰²è®¾å®š</h3>
        
        <label for="charDesc">
          <span>âœï¸</span>
          è§’è‰²è®¾å®šç®€è¿°:
        </label>
        <textarea id="charDesc" placeholder="æè¿°æ‚¨çš„è§’è‰²ï¼ŒåŒ…æ‹¬å§“åã€æ€§æ ¼ã€èƒŒæ™¯ã€å¤–è²Œã€ç‰¹æ®Šèƒ½åŠ›ã€è¡Œä¸ºæ¨¡å¼ç­‰..." oninput="debouncedPreview('character')"></textarea>
        
        <div class="character-extra">
          <div>
            <label for="firstMessage">
              <span>ğŸ’¬</span>
              è§’è‰²å¼€åœºç™½:
            </label>
            <textarea id="firstMessage" placeholder="è§’è‰²çš„ç¬¬ä¸€å¥è¯ï¼Œç”¨äºå¯¹è¯å¼€å§‹æ—¶..."></textarea>
          </div>
          <div>
            <label for="scenario">
              <span>ğŸŒ†</span>
              åœºæ™¯è®¾å®š:
            </label>
            <textarea id="scenario" placeholder="è§’è‰²å‡ºç°çš„åœºæ™¯æè¿°..."></textarea>
          </div>
        </div>
        
        <label for="charFilename">
          <span>ğŸ“</span>
          æ–‡ä»¶å:
        </label>
        <input type="text" id="charFilename" value="generated_character.json">
      </div>
      
      <div class="preview-section">
        <h3><span>ğŸ”</span> é¢„è§ˆ</h3>
        <pre id="charOutput">è¾“å…¥è§’è‰²æè¿°åï¼Œé¢„è§ˆå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</pre>
        
        <button id="generateCharBtn" class="action" onclick="generateCharacterCard()">
          <span>ğŸš€</span>
          ç”Ÿæˆå¹¶ä¸‹è½½è§’è‰²å¡ JSON
        </button>
      </div>
    </div>
  </div>

  <div class="description-tip">
    <h3><span>ğŸ“</span> ä½¿ç”¨æç¤ºä¸ç¤ºä¾‹</h3>
    
    <div class="tip-content">
      <div class="examples">
        <div class="example-title">
          <span>ğŸŒ</span>
          ä¸–ç•Œè§‚ç¤ºä¾‹:
        </div>
        <div class="example-content">
          <p><strong>å¥‡å¹»è’¸æ±½æœ‹å…‹ä¸–ç•Œ</strong></p>
          <p>ä¸€ä¸ªç»“åˆäº†é­”æ³•ä¸è’¸æ±½ç§‘æŠ€çš„ä¸–ç•Œï¼Œä¸»è¦å¤§é™†ç”±å››ä¸ªå¸å›½ç»Ÿæ²»ã€‚åŒ—æ–¹å¸å›½ä»¥å¼ºå¤§çš„æœºæ¢°æŠ€æœ¯é—»åï¼Œå—æ–¹å¸å›½ç²¾é€šå…ƒç´ é­”æ³•ï¼Œè¥¿æ–¹ç¾¤å²›æ˜¯æµ·ç›—å’Œå•†äººçš„å®¶å›­ï¼Œä¸œæ–¹æ²™æ¼ æœ‰å¤è€çš„é—è¿¹å’Œç¥ç§˜ç”Ÿç‰©ã€‚é­”æ³•èƒ½é‡ï¼ˆç§°ä¸º"ä»¥å¤ª"ï¼‰é©±åŠ¨ç€å·¨å¤§çš„è’¸æ±½æœºæ¢°ï¼Œä½†è¿‡åº¦ä½¿ç”¨ä¼šå¯¼è‡´"ä»¥å¤ªæ±¡æŸ“"ã€‚ä¸–ç•Œæ­£é¢ä¸´èµ„æºæ¯ç«­å±æœºï¼Œå„å›½å…³ç³»ç´§å¼ ã€‚</p>
        </div>
        
        <div class="example-title">
          <span>ğŸ­</span>
          è§’è‰²å¡ç¤ºä¾‹:
        </div>
        <div class="example-content">
          <p><strong>è‰äºšÂ·é£è¯­è€…</strong></p>
          <p>25å²çš„åŠç²¾çµæ¸¸ä¾ ï¼Œæ€§æ ¼ç‹¬ç«‹è€Œè°¨æ…ï¼Œæœ‰ç€é“¶ç™½è‰²é•¿å‘å’Œç¿ ç»¿çœ¼ç›ã€‚å‡ºç”Ÿåœ¨æ£®æ—è¾¹å¢ƒæ‘åº„ï¼Œå®¶äººè¢«å¸å›½å£«å…µæ€å®³åæˆä¸ºæµæµªè€…ã€‚æ“…é•¿å¼“ç®­å’Œè¿½è¸ªï¼Œèƒ½ä¸åŠ¨ç‰©æ²Ÿé€šã€‚å¯¹å¸å›½å……æ»¡ä»‡æ¨ä½†ä¿æŒç†æ€§ï¼Œç›®æ ‡æ˜¯æ­éœ²å¸å›½å¯¹æ£®æ—çš„ç ´åè®¡åˆ’ã€‚è¯´è¯ç®€æ´ç›´æ¥ï¼Œè¡ŒåŠ¨å‰ä¼šä»”ç»†è§‚å¯Ÿç¯å¢ƒã€‚</p>
          <p><strong>å¼€åœºç™½:</strong> "æˆ‘æ³¨æ„åˆ°ä½ è·Ÿè¸ªæˆ‘å¾ˆä¹…äº†ã€‚è¯´å§ï¼Œä½ æ˜¯å¸å›½æ´¾æ¥çš„æ¢å­ï¼Œè¿˜æ˜¯åªæ˜¯è¿·è·¯çš„æ—…äººï¼Ÿ"</p>
        </div>
        
        <div class="example-title">
          <span>ğŸ“Š</span>
          MVUçŠ¶æ€æ ç¤ºä¾‹:
        </div>
        <div class="example-content">
          <pre>
ğŸ’– å¥½æ„Ÿåº¦: &lt;%- SafeGetValue(msg_data.ç†.å¥½æ„Ÿåº¦) %&gt;&lt;br&gt;
ğŸŒ ä¸–ç•Œæ—¶é—´: &lt;%- SafeGetValue(msg_data.ä¸–ç•Œ.æ—¶é—´) %&gt;&lt;br&gt;
âš”ï¸ é˜µè¥å…³ç³»: &lt;%- SafeGetValue(msg_data.é˜µè¥.å…³ç³») %&gt;&lt;br&gt;
ğŸ’§ ä»¥å¤ªæ±¡æŸ“: &lt;%- SafeGetValue(msg_data.ä¸–ç•Œ.ä»¥å¤ªæ±¡æŸ“) %&gt;&lt;br&gt;</pre>
        </div>
      </div>
      
      <div>
        <div class="example-title">
          <span>ğŸ’¡</span>
          ä½¿ç”¨æŒ‡å—:
        </div>
        <div class="example-content">
          <p><strong>1. é…ç½®API</strong></p>
          <p>â€¢ é€‰æ‹©APIæä¾›å•†ï¼ˆOpenAIæˆ–è‡ªå®šä¹‰ï¼‰</p>
          <p>â€¢ è¾“å…¥æ­£ç¡®çš„APIåœ°å€å’Œå¯†é’¥</p>
          <p>â€¢ ç³»ç»Ÿä¼šè‡ªåŠ¨åŠ è½½å¯ç”¨æ¨¡å‹</p>
          
          <p><strong>2. è§’è‰²å¡ç”Ÿæˆ</strong></p>
          <p>â€¢ å¡«å†™è§’è‰²è®¾å®šç®€è¿°</p>
          <p>â€¢ æ·»åŠ è§’è‰²å¼€åœºç™½å’Œåœºæ™¯è®¾å®š</p>
          <p>â€¢ ç”Ÿæˆè§’è‰²å¡JSONæ–‡ä»¶</p>
          
          <p><strong>3. ä¸–ç•Œä¹¦ç”Ÿæˆ</strong></p>
          <p>â€¢ å¡«å†™ä¸–ç•Œè§‚ç®€è¿°</p>
          <p>â€¢ ä½¿ç”¨è§’è‰²å¡ç»†åŒ–ä¸–ç•Œè§‚ï¼ˆå¯é€‰ï¼‰</p>
          <p>â€¢ æ·»åŠ MVUçŠ¶æ€æ å˜é‡</p>
          <p>â€¢ ç”Ÿæˆä¸–ç•Œä¹¦JSONæ–‡ä»¶</p>
        </div>
        
        <div class="example-title">
          <span>âš ï¸</span>
          æ³¨æ„äº‹é¡¹:
        </div>
        <div class="example-content">
          <p>â€¢ è§’è‰²å¼€åœºç™½ä¼šç›´æ¥å½±å“è§’è‰²åœ¨å¯¹è¯ä¸­çš„ç¬¬ä¸€å¥è¯</p>
          <p>â€¢ ä¸–ç•Œä¹¦ç”Ÿæˆå¯ä»¥é€‰æ‹©æ ¹æ®è§’è‰²å¡ç»†åŒ–ä¸–ç•Œè§‚</p>
          <p>â€¢ MVUçŠ¶æ€æ å˜é‡éœ€è¦æè¿°æ¸…æ¥šéœ€è¦è·Ÿè¸ªçš„çŠ¶æ€</p>
          <p>â€¢ ç”Ÿæˆè¿‡ç¨‹ä¸­è¯·å‹¿å…³é—­é¡µé¢</p>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// APIæä¾›å•†é…ç½®
const apiProviders = {
  openai: {
    baseUrl: "https://api.openai.com/v1",
    modelsEndpoint: "/models",
    chatEndpoint: "/chat/completions",
    authHeader: "Bearer",
    defaultModel: "gpt-3.5-turbo"
  },
  custom: {
    baseUrl: "",
    modelsEndpoint: "/models",
    chatEndpoint: "/chat/completions",
    authHeader: "Bearer",
    defaultModel: ""
  }
};

// æ¨¡æ¿å®šä¹‰
const worldTemplate = {
  "world_name": "ç”Ÿæˆçš„ä¸–ç•Œåç§°",
  "description": "ä¸–ç•Œçš„æ€»ä½“æè¿°",
  "history": "ä¸–ç•Œçš„å†å²èƒŒæ™¯",
  "geography": "åœ°ç†ç¯å¢ƒæè¿°",
  "culture": "ä¸»è¦æ–‡åŒ–ç‰¹å¾",
  "races": ["ç§æ—1", "ç§æ—2", "ç§æ—3"],
  "magic_system": "é­”æ³•æˆ–ç§‘æŠ€ç³»ç»Ÿ",
  "politics": "æ”¿æ²»ç»“æ„",
  "key_locations": {
    "location1": "é‡è¦åœ°ç‚¹1çš„æè¿°",
    "location2": "é‡è¦åœ°ç‚¹2çš„æè¿°"
  },
  "important_events": ["äº‹ä»¶1", "äº‹ä»¶2"],
  "creator_notes": "åˆ›å»ºè€…å¤‡æ³¨"
};

const characterTemplate = {
  "name": "è§’è‰²åç§°",
  "description": "è§’è‰²ç®€è¦æè¿°",
  "personality": "æ€§æ ¼ç‰¹ç‚¹",
  "appearance": "å¤–è²Œç‰¹å¾",
  "background": "èƒŒæ™¯æ•…äº‹",
  "motivations": "åŠ¨æœºå’Œç›®æ ‡",
  "abilities": ["èƒ½åŠ›1", "èƒ½åŠ›2"],
  "relationships": {
    "relationship1": "å…³ç³»1æè¿°",
    "relationship2": "å…³ç³»2æè¿°"
  },
  "first_mes": "è§’è‰²ç¬¬ä¸€æ¡æ¶ˆæ¯ç¤ºä¾‹",
  "scenario": "åœºæ™¯è®¾å®š",
  "mes_example": "å¯¹è¯ç¤ºä¾‹",
  "creator_notes": "åˆ›å»ºè€…å¤‡æ³¨"
};

// çŠ¶æ€ç®¡ç†
const state = {
  world: {
    generating: false,
    previewing: false,
    lastRequest: null
  },
  character: {
    generating: false,
    previewing: false,
    lastRequest: null
  }
};

// DOMåŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
  // è®¾ç½®é»˜è®¤æ¨¡å‹
  const modelWorld = document.getElementById('modelWorld');
  const optionWorld = document.createElement('option');
  optionWorld.value = apiProviders.openai.defaultModel;
  optionWorld.textContent = apiProviders.openai.defaultModel;
  modelWorld.appendChild(optionWorld);
  
  const modelChar = document.getElementById('modelChar');
  const optionChar = document.createElement('option');
  optionChar.value = apiProviders.openai.defaultModel;
  optionChar.textContent = apiProviders.openai.defaultModel;
  modelChar.appendChild(optionChar);
  
  // åˆå§‹çŠ¶æ€
  document.getElementById('worldOutput').textContent = JSON.stringify(worldTemplate, null, 2);
  document.getElementById('charOutput').textContent = JSON.stringify(characterTemplate, null, 2);
  
  // è®¾ç½®è¿›åº¦æ¡
  setProgress('world', 0);
  setProgress('character', 0);
  
  // åˆå§‹åŒ–æ ‡ç­¾é¡µæŒ‡ç¤ºå™¨
  updateTabIndicator();
});

// åˆ‡æ¢æ ‡ç­¾é¡µ - å·²ä¿®å¤
function showTab(id) {
  // éšè—æ‰€æœ‰æ ‡ç­¾é¡µ
  document.querySelectorAll('.tab').forEach(tab => {
    tab.classList.remove('active');
  });
  
  // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾é¡µ
  document.getElementById(id).classList.add('active');
  
  // æ›´æ–°æ ‡ç­¾æŒ‰é’®çŠ¶æ€
  document.querySelectorAll('.tab-button').forEach(button => {
    button.classList.remove('active');
  });
  
  // è®¾ç½®å½“å‰æŒ‰é’®ä¸ºæ¿€æ´»çŠ¶æ€
  const activeButton = Array.from(document.querySelectorAll('.tab-button'))
    .find(button => button.textContent.includes(id === 'world' ? 'ä¸–ç•Œä¹¦' : 'è§’è‰²å¡'));
  
  if (activeButton) {
    activeButton.classList.add('active');
  }
  
  // æ›´æ–°æ ‡ç­¾æŒ‡ç¤ºå™¨ä½ç½®
  updateTabIndicator();
}

// æ›´æ–°æ ‡ç­¾é¡µæŒ‡ç¤ºå™¨ä½ç½®
function updateTabIndicator() {
  const activeButton = document.querySelector('.tab-button.active');
  const indicator = document.getElementById('tabIndicator');
  
  if (activeButton && indicator) {
    const buttonRect = activeButton.getBoundingClientRect();
    const tabsRect = document.querySelector('.tabs').getBoundingClientRect();
    
    indicator.style.width = `${buttonRect.width}px`;
    indicator.style.left = `${buttonRect.left - tabsRect.left}px`;
  }
}

// åˆ‡æ¢APIæä¾›å•†
function changeApiProvider(type) {
  const tabType = type === 'world' ? 'World' : 'Char';
  const providerSelect = document.getElementById(`apiProvider${tabType}`);
  const apiUrlInput = document.getElementById(`apiUrl${tabType}`);
  
  if (providerSelect.value === 'openai') {
    apiUrlInput.value = apiProviders.openai.baseUrl;
    apiUrlInput.readOnly = true;
  } else {
    apiUrlInput.value = '';
    apiUrlInput.readOnly = false;
    apiUrlInput.placeholder = "è¾“å…¥æ‚¨çš„APIåŸºç¡€åœ°å€ï¼Œå¦‚: https://ai.nyabit.com/v1";
  }
}

// è®¾ç½®è¿›åº¦æ¡
function setProgress(type, percent) {
  const progressBar = document.getElementById(`modelProgress${type === 'world' ? 'World' : 'Char'}`);
  if (progressBar) {
    progressBar.style.width = `${percent}%`;
  }
}

// è‡ªåŠ¨è·å–æ¨¡å‹
async function autoFetchModels(type) {
  const tabType = type === 'world' ? 'World' : 'Char';
  const providerSelect = document.getElementById(`apiProvider${tabType}`);
  const provider = apiProviders[providerSelect.value];
  
  const apiUrlInput = document.getElementById(`apiUrl${tabType}`);
  let baseUrl = provider.baseUrl;
  
  // å¦‚æœæ˜¯è‡ªå®šä¹‰APIï¼Œä½¿ç”¨ç”¨æˆ·è¾“å…¥çš„URL
  if (providerSelect.value === 'custom') {
    baseUrl = apiUrlInput.value.trim().replace(/\/+$/, '');
    if (!baseUrl) return;
  }

  const apiKey = document.getElementById(`apiKey${tabType}`).value.trim();
  const select = document.getElementById(`model${tabType}`);
  const statusElement = document.getElementById(`modelStatus${tabType}`);
  
  if (!apiKey) {
    statusElement.innerHTML = `<span class="error">âš ï¸ è¯·è¾“å…¥APIå¯†é’¥</span>`;
    return;
  }
  
  // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
  statusElement.innerHTML = `<div class="loading"><div class="spinner"></div> æ­£åœ¨è·å–æ¨¡å‹åˆ—è¡¨...</div>`;
  
  // æ¨¡æ‹Ÿè¿›åº¦æ¡
  let progress = 0;
  const progressInterval = setInterval(() => {
    progress = Math.min(progress + 5, 90);
    setProgress(type, progress);
  }, 200);
  
  try {
    const modelsUrl = baseUrl + provider.modelsEndpoint;
    const resp = await fetchWithTimeout(modelsUrl, {
      method: 'GET',
      headers: {
        'Authorization': `${provider.authHeader} ${apiKey}`,
        'Content-Type': 'application/json'
      }
    }, 10000); // 10ç§’è¶…æ—¶
    
    if (!resp.ok) {
      throw new Error(`APIè¯·æ±‚å¤±è´¥: ${resp.status} ${resp.statusText}`);
    }
    
    const data = await resp.json();
    
    // å¤„ç†ä¸åŒçš„APIå“åº”æ ¼å¼
    let models = [];
    if (Array.isArray(data)) {
      models = data;
    } else if (data.data && Array.isArray(data.data)) {
      models = data.data;
    } else {
      throw new Error('æ¨¡å‹åˆ—è¡¨æ ¼å¼ä¸ç¬¦åˆé¢„æœŸ');
    }
    
    if (models.length === 0) {
      throw new Error('æ²¡æœ‰å¯ç”¨çš„æ¨¡å‹');
    }
    
    // æ¸…ç©ºç°æœ‰é€‰é¡¹
    select.innerHTML = '';
    
    // æ·»åŠ æ¨¡å‹é€‰é¡¹
    models.forEach(m => {
      const modelId = m.id || m;
      const o = document.createElement('option');
      o.value = modelId;
      o.textContent = modelId;
      select.appendChild(o);
    });
    
    statusElement.innerHTML = `<span class="success">âœ… æ¨¡å‹åˆ—è¡¨åŠ è½½å®Œæˆ (${models.length}ä¸ªæ¨¡å‹)</span>`;
    setProgress(type, 100);
    
  } catch (e) {
    console.error('è·å–æ¨¡å‹åˆ—è¡¨é”™è¯¯:', e);
    statusElement.innerHTML = `<span class="error">âŒ é”™è¯¯: ${e.message}</span>`;
    setProgress(type, 0);
    
    // æ·»åŠ ä¸€ä¸ªé»˜è®¤é€‰é¡¹
    select.innerHTML = '';
    const defaultOption = document.createElement('option');
    defaultOption.value = '';
    defaultOption.textContent = 'æ— æ³•è·å–æ¨¡å‹åˆ—è¡¨';
    select.appendChild(defaultOption);
  } finally {
    clearInterval(progressInterval);
  }
}

// å¸¦è¶…æ—¶çš„fetchå‡½æ•°
function fetchWithTimeout(url, options, timeout = 8000) {
  return Promise.race([
    fetch(url, options),
    new Promise((_, reject) =>
      setTimeout(() => reject(new Error('è¯·æ±‚è¶…æ—¶')), timeout)
    )
  ]);
}

// é˜²æŠ–å‡½æ•°
function debounce(func, wait) {
  let timeout;
  return function(...args) {
    clearTimeout(timeout);
    timeout = setTimeout(() => func.apply(this, args), wait);
  }
}

// å®æ—¶é¢„è§ˆ
const debouncedPreview = debounce(async function(type) {
  if (type === 'world') await previewWorld();
  else if (type === 'character') await previewChar();
}, 1500); // 1.5ç§’é˜²æŠ–

// å¤„ç†JSONè§£æé”™è¯¯
function safeJsonParse(str) {
  try {
    return JSON.parse(str);
  } catch (e) {
    // å°è¯•ä¿®å¤å¸¸è§çš„JSONé”™è¯¯
    try {
      // å°è¯•æå–ç¬¬ä¸€ä¸ªæœ‰æ•ˆçš„JSONå¯¹è±¡
      const jsonMatch = str.match(/{[\s\S]*}|\[[\s\S]*]/);
      if (jsonMatch) {
        return JSON.parse(jsonMatch[0]);
      }
      
      // å°è¯•ä¿®å¤ç¼ºå°‘å¼•å·çš„é—®é¢˜
      const fixedStr = str
        .replace(/(\w+):/g, '"$1":')  // ä¸ºé”®æ·»åŠ å¼•å·
        .replace(/:(\w+)([,}])/g, ':"$1"$2')  // ä¸ºå­—ç¬¦ä¸²å€¼æ·»åŠ å¼•å·
        .replace(/:([^"{\[\d][^,}\]\s]*)/g, ':"$1"'); // ä¸ºæœªåŠ å¼•å·çš„å€¼æ·»åŠ å¼•å·
        
      return JSON.parse(fixedStr);
    } catch (fixError) {
      console.error('JSONä¿®å¤å¤±è´¥:', fixError);
      return {
        error: 'JSONè§£æå¤±è´¥',
        originalContent: str,
        errorMessage: e.message
      };
    }
  }
}

// å¸¦å–æ¶ˆåŠŸèƒ½çš„APIè¯·æ±‚
async function makeApiRequest(type, prompt, signal) {
  const tabType = type === 'world' ? 'World' : 'Char';
  const providerSelect = document.getElementById(`apiProvider${tabType}`);
  const provider = apiProviders[providerSelect.value];
  
  let baseUrl = provider.baseUrl;
  if (providerSelect.value === 'custom') {
    baseUrl = document.getElementById(`apiUrl${tabType}`).value.trim().replace(/\/+$/, '');
  }
  
  const apiUrl = baseUrl + provider.chatEndpoint;
  const apiKey = document.getElementById(`apiKey${tabType}`).value.trim();
  const model = document.getElementById(`model${tabType}`).value;
  
  if (!model) {
    throw new Error('è¯·é€‰æ‹©æ¨¡å‹');
  }
  
  // æ„å»ºè¯·æ±‚ä½“
  const requestBody = {
    model: model,
    messages: [{role: 'user', content: prompt}],
    temperature: 0.7,
    response_format: { type: "json_object" } // è¦æ±‚APIè¿”å›JSONæ ¼å¼
  };
  
  try {
    const response = await fetchWithTimeout(apiUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `${provider.authHeader} ${apiKey}`
      },
      body: JSON.stringify(requestBody),
      signal: signal // ä¼ é€’AbortSignal
    }, 15000); // 15ç§’è¶…æ—¶
    
    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(`APIé”™è¯¯: ${response.status} - ${errorData.error?.message || response.statusText}`);
    }
    
    const data = await response.json();
    
    // å¤„ç†ä¸åŒAPIçš„è¿”å›ç»“æ„
    if (providerSelect.value === 'openai') {
      return data.choices?.[0]?.message?.content;
    } else {
      // è‡ªå®šä¹‰APIå¯èƒ½è¿”å›ä¸åŒç»“æ„
      return data.result || data.response || data.choices?.[0]?.text || data.choices?.[0]?.message?.content;
    }
  } catch (error) {
    if (error.name === 'AbortError') {
      console.log('è¯·æ±‚è¢«å–æ¶ˆ');
      return null;
    }
    console.error('APIè¯·æ±‚é”™è¯¯:', error);
    throw error;
  }
}

// ç”ŸæˆMVUçŠ¶æ€æ 
function generateMvuStatus(variablesDesc) {
  if (!variablesDesc) return '';
  
  // æå–å˜é‡å¹¶ç”ŸæˆEJSä»£ç 
  const variables = variablesDesc.split(/[\n,ï¼Œ]/).filter(v => v.trim() !== '');
  
  let ejsCode = `<%
  if (runType == 'render')
  {
      function SafeGetValue(value, defaultValue = "") {
          // å¦‚æœå€¼ä¸å­˜åœ¨ï¼Œè¿”å›é»˜è®¤å€¼
          if (value === undefined || value === null) {
              return defaultValue;
          }
          // å¦‚æœæ˜¯æ•°ç»„ï¼Œå–ç¬¬ä¸€ä¸ªå…ƒç´ 
          if (Array.isArray(value)) {
              return value.length !== 0 ? value : defaultValue;
          }
          // å¦åˆ™ç›´æ¥è¿”å›è¯¥å€¼æœ¬èº«
          return value;
      }
      const data = window.TavernHelper.getVariables({type: 'message', message_id: message_id});
      const msg_data = data.display_data;
  %>
  `;
  
  variables.forEach((variable, index) => {
    const varName = variable.trim();
    if (!varName) return;
    
    // ä¸ºå˜é‡ç”Ÿæˆå›¾æ ‡å’Œæ ‡ç­¾
    const icons = ['ğŸ’–', 'ğŸŒ', 'âš”ï¸', 'ğŸ’§', 'ğŸ”®', 'ğŸ•’', 'ğŸ”‹', 'ğŸ”­', 'ğŸ“œ', 'âš™ï¸'];
    const icon = icons[index % icons.length];
    
    ejsCode += `${icon} ${varName}: <%- SafeGetValue(msg_data.${varName.replace(/\s+/g, '_')}) %><br>\n`;
  });
  
  ejsCode += `<%}%>`;
  
  return ejsCode;
}

// é¢„è§ˆä¸–ç•Œä¹¦
async function previewWorld() {
  if (state.world.previewing) return;
  
  const desc = document.getElementById('worldDesc').value.trim();
  const output = document.getElementById('worldOutput');
  
  if (!desc) {
    output.textContent = "è¯·è¾“å…¥ä¸–ç•Œè§‚æè¿°";
    return;
  }
  
  state.world.previewing = true;
  const controller = new AbortController();
  state.world.lastRequest = controller;
  
  try {
    output.textContent = "æ­£åœ¨ç”Ÿæˆé¢„è§ˆ...";
    document.getElementById('generateWorldBtn').disabled = true;
    
    // æ”¹è¿›çš„æç¤ºæ¨¡æ¿
    const prompt = `ä½ æ˜¯ä¸€ä¸ªä¸–ç•Œä¹¦ç”Ÿæˆä¸“å®¶ï¼Œæ ¹æ®ä»¥ä¸‹æè¿°åˆ›å»ºä¸€ä¸ªå¥‡å¹»ä¸–ç•Œçš„è¯¦ç»†è®¾å®šã€‚åªè¾“å‡ºä¸¥æ ¼ç¬¦åˆä»¥ä¸‹JSONç»“æ„çš„å¯¹è±¡ï¼Œä¸è¦ä»»ä½•é¢å¤–æ–‡å­—ã€‚ä½¿ç”¨ä¸­æ–‡æè¿°ã€‚
    
    å‚è€ƒç»“æ„ï¼š
    ${JSON.stringify(worldTemplate, null, 2)}
    
    ä¸–ç•Œæè¿°ï¼š${desc}`;
    
    const content = await makeApiRequest('world', prompt, controller.signal);
    
    if (content === null) return; // è¯·æ±‚è¢«å–æ¶ˆ
    
    // ä½¿ç”¨å®‰å…¨çš„JSONè§£æ
    const jsonData = safeJsonParse(content);
    output.textContent = JSON.stringify(jsonData, null, 2);
  } catch (err) {
    output.textContent = `é¢„è§ˆå¤±è´¥: ${err.message}\n\nè¯·æ£€æŸ¥APIè®¾ç½®å’Œç½‘ç»œè¿æ¥ã€‚`;
  } finally {
    state.world.previewing = false;
    document.getElementById('generateWorldBtn').disabled = false;
  }
}

// é¢„è§ˆè§’è‰²å¡
async function previewChar() {
  if (state.character.previewing) return;
  
  const desc = document.getElementById('charDesc').value.trim();
  const output = document.getElementById('charOutput');
  
  if (!desc) {
    output.textContent = "è¯·è¾“å…¥è§’è‰²æè¿°";
    return;
  }
  
  state.character.previewing = true;
  const controller = new AbortController();
  state.character.lastRequest = controller;
  
  try {
    output.textContent = "æ­£åœ¨ç”Ÿæˆé¢„è§ˆ...";
    document.getElementById('generateCharBtn').disabled = true;
    
    // æ”¹è¿›çš„æç¤ºæ¨¡æ¿
    const prompt = `ä½ æ˜¯ä¸€ä¸ªè§’è‰²å¡ç”Ÿæˆä¸“å®¶ï¼Œæ ¹æ®ä»¥ä¸‹æè¿°åˆ›å»ºä¸€ä¸ªè¯¦ç»†çš„è§’è‰²è®¾å®šã€‚åªè¾“å‡ºä¸¥æ ¼ç¬¦åˆä»¥ä¸‹JSONç»“æ„çš„å¯¹è±¡ï¼Œä¸è¦ä»»ä½•é¢å¤–æ–‡å­—ã€‚ä½¿ç”¨ä¸­æ–‡æè¿°ã€‚
    
    å‚è€ƒç»“æ„ï¼š
    ${JSON.stringify(characterTemplate, null, 2)}
    
    è§’è‰²æè¿°ï¼š${desc}`;
    
    const content = await makeApiRequest('character', prompt, controller.signal);
    
    if (content === null) return; // è¯·æ±‚è¢«å–æ¶ˆ
    
    // ä½¿ç”¨å®‰å…¨çš„JSONè§£æ
    const jsonData = safeJsonParse(content);
    output.textContent = JSON.stringify(jsonData, null, 2);
  } catch (err) {
    output.textContent = `é¢„è§ˆå¤±è´¥: ${err.message}\n\nè¯·æ£€æŸ¥APIè®¾ç½®å’Œç½‘ç»œè¿æ¥ã€‚`;
  } finally {
    state.character.previewing = false;
    document.getElementById('generateCharBtn').disabled = false;
  }
}

// ç”Ÿæˆä¸–ç•Œä¹¦
async function generateWorldInfo() {
  if (state.world.generating) return;
  
  const desc = document.getElementById('worldDesc').value.trim();
  const filename = document.getElementById('worldFilename').value;
  const output = document.getElementById('worldOutput');
  const refineWithCharacters = document.getElementById('refineWithCharacters').checked;
  const statusVariables = document.getElementById('statusVariables').value.trim();
  
  if (!desc) {
    output.textContent = "è¯·è¾“å…¥ä¸–ç•Œè§‚æè¿°";
    return;
  }
  
  state.world.generating = true;
  const controller = new AbortController();
  
  // å–æ¶ˆä¹‹å‰çš„é¢„è§ˆè¯·æ±‚
  if (state.world.lastRequest) {
    state.world.lastRequest.abort();
  }
  
  try {
    output.textContent = "æ­£åœ¨ç”Ÿæˆå®Œæ•´ä¸–ç•Œä¹¦...";
    document.getElementById('generateWorldBtn').disabled = true;
    document.getElementById('generateWorldBtn').innerHTML = `<div class="spinner"></div> ç”Ÿæˆä¸­...`;
    
    // æ›´è¯¦ç»†çš„ç”Ÿæˆæç¤º
    let prompt = `ä½ æ˜¯ä¸€ä¸ªä¸–ç•Œä¹¦ç”Ÿæˆä¸“å®¶ï¼Œæ ¹æ®ä»¥ä¸‹æè¿°åˆ›å»ºä¸€ä¸ªå¥‡å¹»ä¸–ç•Œçš„è¯¦ç»†è®¾å®šã€‚è¾“å‡ºä¸€ä¸ªè¯¦ç»†çš„JSONå¯¹è±¡ï¼ŒåŒ…å«ä»¥ä¸‹å­—æ®µï¼šworld_name, description, history, geography, culture, races, magic_system, politics, key_locations, important_events, creator_notesã€‚ä½¿ç”¨ä¸­æ–‡æè¿°ã€‚
    
    ä¸–ç•Œæè¿°ï¼š${desc}`;
    
    // å¦‚æœå¯ç”¨äº†è§’è‰²å¡ç»†åŒ–
    if (refineWithCharacters) {
      const charData = localStorage.getItem('characterData');
      if (charData) {
        const charJson = JSON.parse(charData);
        prompt += `\n\nåŸºäºä»¥ä¸‹è§’è‰²å¡ç»†åŒ–ä¸–ç•Œè§‚ï¼š\n${JSON.stringify(charJson, null, 2)}`;
      }
    }
    
    const content = await makeApiRequest('world', prompt, controller.signal);
    
    if (content === null) return; // è¯·æ±‚è¢«å–æ¶ˆ
    
    // ä½¿ç”¨å®‰å…¨çš„JSONè§£æ
    let jsonData = safeJsonParse(content);
    
    // æ·»åŠ MVUçŠ¶æ€æ 
    if (statusVariables) {
      jsonData.mvu_status_bar = generateMvuStatus(statusVariables);
    }
    
    // æ·»åŠ ä¸–ç•Œç»†åŒ–ç»“æ„
    jsonData.world_structure = {
      "1. æ¥æ”¶ä¸é™é»˜åˆ†æ": "æ¥æ”¶ç”¨æˆ·å‘é€çš„å…¨éƒ¨æ–‡æœ¬",
      "2. æ™ºèƒ½å®ä½“æå–": {
        "åœ°ç‚¹å®ä½“": "è¯†åˆ«åœ°ç†åè¯å¹¶åˆ›å»ºæ€»è§ˆå’Œè¯¦æƒ…æ¡ç›®",
        "ç»„ç»‡å®ä½“": "è¯†åˆ«ç¾¤ä½“åè¯å¹¶åˆ›å»ºæ€»è§ˆå’Œè¯¦æƒ…æ¡ç›®",
        "äººç‰©å®ä½“": "è¯†åˆ«äººç‰©å’Œç§æ—å¹¶åˆ›å»ºæ€»è§ˆå’Œè¯¦æƒ…æ¡ç›®",
        "è§„åˆ™å®ä½“": "è¯†åˆ«ä¸–ç•Œè¿ä½œè§„å¾‹å¹¶åˆ›å»ºæ ¸å¿ƒè§„åˆ™æ¡ç›®",
        "äº‹ä»¶å®ä½“": "è¯†åˆ«å†å²äº‹ä»¶å¹¶åˆ›å»ºæ—¶é—´çº¿æ¡ç›®",
        "ç‰©å“å®ä½“": "è¯†åˆ«é‡è¦ç‰©å“å’ŒæŠ€æœ¯å¹¶åˆ›å»ºæ¡ç›®"
      },
      "3. æ„å»ºå±‚çº§ç»“æ„": "åˆ›å»ºåŒ…å«æ€»è§ˆæ¡ç›®å’Œè¯¦æƒ…æ¡ç›®çš„å±‚çº§ç»“æ„",
      "4. å¡«å……ä¸ç”Ÿæˆå†…å®¹": "å°†æè¿°å¡«å……åˆ°å¯¹åº”æ¡ç›®ä¸­"
    };
    
    downloadFile(filename, JSON.stringify(jsonData, null, 2));
    output.textContent = JSON.stringify(jsonData, null, 2);
  } catch (err) {
    output.textContent = `ç”Ÿæˆå¤±è´¥: ${err.message}\n\nè¯·æ£€æŸ¥APIè®¾ç½®å’Œç½‘ç»œè¿æ¥ã€‚`;
  } finally {
    state.world.generating = false;
    document.getElementById('generateWorldBtn').disabled = false;
    document.getElementById('generateWorldBtn').innerHTML = `<span>ğŸš€</span> ç”Ÿæˆå¹¶ä¸‹è½½ä¸–ç•Œä¹¦ JSON`;
  }
}

// ç”Ÿæˆè§’è‰²å¡
async function generateCharacterCard() {
  if (state.character.generating) return;
  
  const desc = document.getElementById('charDesc').value.trim();
  const filename = document.getElementById('charFilename').value;
  const output = document.getElementById('charOutput');
  const firstMessage = document.getElementById('firstMessage').value.trim();
  const scenario = document.getElementById('scenario').value.trim();
  
  if (!desc) {
    output.textContent = "è¯·è¾“å…¥è§’è‰²æè¿°";
    return;
  }
  
  state.character.generating = true;
  const controller = new AbortController();
  
  // å–æ¶ˆä¹‹å‰çš„é¢„è§ˆè¯·æ±‚
  if (state.character.lastRequest) {
    state.character.lastRequest.abort();
  }
  
  try {
    output.textContent = "æ­£åœ¨ç”Ÿæˆå®Œæ•´è§’è‰²å¡...";
    document.getElementById('generateCharBtn').disabled = true;
    document.getElementById('generateCharBtn').innerHTML = `<div class="spinner"></div> ç”Ÿæˆä¸­...`;
    
    // æ›´è¯¦ç»†çš„ç”Ÿæˆæç¤º
    let prompt = `ä½ æ˜¯ä¸€ä¸ªè§’è‰²å¡ç”Ÿæˆä¸“å®¶ï¼Œæ ¹æ®ä»¥ä¸‹æè¿°åˆ›å»ºä¸€ä¸ªè¯¦ç»†çš„è§’è‰²è®¾å®šã€‚è¾“å‡ºä¸€ä¸ªè¯¦ç»†çš„JSONå¯¹è±¡ï¼ŒåŒ…å«ä»¥ä¸‹å­—æ®µï¼šname, description, personality, appearance, background, motivations, abilities, relationships, first_mes, scenario, mes_example, creator_notesã€‚ä½¿ç”¨ä¸­æ–‡æè¿°ã€‚
    
    è§’è‰²æè¿°ï¼š${desc}`;
    
    // æ·»åŠ å¼€åœºç™½å’Œåœºæ™¯è®¾å®š
    if (firstMessage) {
      prompt += `\nè§’è‰²å¼€åœºç™½ï¼š${firstMessage}`;
    }
    if (scenario) {
      prompt += `\nåœºæ™¯è®¾å®šï¼š${scenario}`;
    }
    
    const content = await makeApiRequest('character', prompt, controller.signal);
    
    if (content === null) return; // è¯·æ±‚è¢«å–æ¶ˆ
    
    // ä½¿ç”¨å®‰å…¨çš„JSONè§£æ
    const jsonData = safeJsonParse(content);
    
    // ä¿å­˜è§’è‰²æ•°æ®ç”¨äºä¸–ç•Œä¹¦ç»†åŒ–
    localStorage.setItem('characterData', JSON.stringify(jsonData));
    
    downloadFile(filename, JSON.stringify(jsonData, null, 2));
    output.textContent = JSON.stringify(jsonData, null, 2);
  } catch (err) {
    output.textContent = `ç”Ÿæˆå¤±è´¥: ${err.message}\n\nè¯·æ£€æŸ¥APIè®¾ç½®å’Œç½‘ç»œè¿æ¥ã€‚`;
  } finally {
    state.character.generating = false;
    document.getElementById('generateCharBtn').disabled = false;
    document.getElementById('generateCharBtn').innerHTML = `<span>ğŸš€</span> ç”Ÿæˆå¹¶ä¸‹è½½è§’è‰²å¡ JSON`;
  }
}

// ä¸‹è½½æ–‡ä»¶
function downloadFile(filename, content) {
  const blob = new Blob([content], {type: 'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);
}
</script>
</body>
</html>